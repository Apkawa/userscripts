// ==UserScript==
// @name         Kinopoisk subtitle petition
// @namespace    http://tampermonkey.net/
// @version      0.2
// @description  Helper for add subtitle petition
// @author       Apkawa
// @match        https://forms.yandex.ru/surveys/10022784.8ae29888f3224e212d4a904160b6baf0a05acd37/*
// @match        https://hd.kinopoisk.ru/*
// @match        https://kinopoisk.ru/*
// @match        https://www.kinopoisk.ru/*
// @icon         https://www.google.com/s2/favicons?domain=kinopoisk.ru
// @require      https://greasemonkey.github.io/gm4-polyfill/gm4-polyfill.js
// @homepage     https://github.com/Apkawa/userscripts
// @homepageUrl  https://github.com/Apkawa/userscripts
// @supportUrl   https://github.com/Apkawa/userscripts/issues/
// @downloadUrl  https://github.com/Apkawa/userscripts/raw/master/dist/hd.kinopoisk.ru/main.user.js
// @updateUrl    https://github.com/Apkawa/userscripts/raw/master/dist/hd.kinopoisk.ru/main.user.js
// @grant        none
// ==/UserScript==
(()=>{const e="https://forms.yandex.ru/surveys/10022784.8ae29888f3224e212d4a904160b6baf0a05acd37/";function t(e,t=document){return document.evaluate(e,t,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}function n(e,t=document){const n=document.evaluate(e,t,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);let i=[],o=n.iterateNext();for(;o;)i.push(o),o=n.iterateNext();return i}function i(e){t(`//p[text() = '${e}']/../..`).click()}function o(e,n){const i=t(`//p[text() = '${e}']/ancestor::tbody//input`);return i.value=n,i}function r(e,t){let n=new MutationObserver((n=>{let i=!1;n.forEach((t=>{if(t.addedNodes)for(let n=0;n<t.addedNodes.length;n++){let o=t.addedNodes[n];i=e(o)}})),i&&t()}));return n.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1}),()=>{n.disconnect()}}function a(e,t={},...n){const i=document.createElement(e);for(const e in t)t.hasOwnProperty(e)&&i.setAttribute(e,t[e]);const o=document.createDocumentFragment();return n.forEach((e=>{"string"==typeof e&&(e=document.createTextNode(e)),o.appendChild(e)})),i.appendChild(o),i}function l(n){let i=t("ancestor::section",n),o=[].slice.call(n.getElementsByTagName("li")).map((e=>e.innerText));if(n.getAttribute("request-added"))return;let r=t("//div[text() = 'Аудиодорожки']/../ul");function l(){return{link:t("//a[text() ='Подробнее на КиноПоиске']/@href",i).value,type:t("//button[text() = 'О сериале']")?"series":"film"}}if(![].slice.call(r.getElementsByTagName("li")).map((e=>e.innerText)).includes("Английский")){let t={...l(),mode:"audio"},n=a("li",{},a("a",{href:e+"?"+new URLSearchParams(t).toString(),target:"_blank"},"Запросить оригинальную озвучку"));r.appendChild(n)}if(!o.includes("Русские")){let t=l(),i=a("li",{},a("a",{href:e+"?"+new URLSearchParams(t).toString(),target:"_blank"},"Запросить русские сабы"));n.appendChild(i)}n.setAttribute("request-added",1)}function s(n){let i=t("ancestor::body",n);if(n.getAttribute("request-added"))return;const o=t("//div[text() = 'Страна']/following-sibling::div",i).innerText;let r=t("//div[text() = 'Аудиодорожки']/following-sibling::div",i),l=r.innerText.split(", "),s=n.innerText.split(", "),d={link:window.location.href,type:window.location.href.match("https://(?:www.|)kinopoisk.ru/(series|film)/")[1]};if(!l.includes("Английский")&&"Россия"!==o){let t=a("a",{href:e+"?"+new URLSearchParams({...d,mode:"audio"}).toString(),target:"_blank"},"Запросить оригинальную озвучку");r.appendChild(t)}if(!s.includes("Русские")){let t=a("a",{href:e+"?"+new URLSearchParams(d).toString(),target:"_blank"},"Запросить русские сабы");n.appendChild(t)}n.setAttribute("request-added",1)}!function(){"use strict";if("forms.yandex.ru"===window.location.hostname){const e=Object.fromEntries(new URLSearchParams(window.location.search).entries());"film"===e.type?i("Фильм"):i("Сериал"),"audio"===e.mode?(i("Аудиодорожку/озвучку"),function(e,n){const i=t("//p[text() = 'Какую аудиодорожку добавить?']/ancestor::tbody//select");t("//option[@selected]",i).removeAttribute("selected");let o=t("//option[text() = 'Оригинальную']",i);i.value=o.value,o.setAttribute("selected",!0)}()):(i("Субтитры"),o("Выберите субтитры:",e.lang||"Русский")),o("Ссылка на фильм/сериал на КиноПоиске",e.link||""),o("Ваша почта",`${t("//span[@class='user__name']").innerText}@yandex.ru`)}if(window.location.href.startsWith("https://hd.kinopoisk.ru/")){let e="//div[text() = 'Субтитры']/../ul";r((n=>t(e,n)),(()=>{let t=n(e);for(let e of t)l(e)}))}if(window.location.href.match("https://(www.|)kinopoisk.ru/(series|film)/")){let e="//div[text() = 'Субтитры']/following-sibling::div";r((n=>t(e,n)),(()=>{let t=n(e);for(let e of t)s(e)}))}}()})();